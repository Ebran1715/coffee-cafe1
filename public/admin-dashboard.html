<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serados Cafe - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        
        .admin-header {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            color: #2e8b57;
            font-size: 24px;
            font-weight: bold;
        }
        
        .admin-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logout-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        
        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
            color: #2e8b57;
            margin-bottom: 10px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn:hover, .filter-btn.active {
            background: #2e8b57;
            color: white;
            border-color: #2e8b57;
        }
        
        .orders-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #2e8b57;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 500;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f9f9f9;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-received { background: #e3f2fd; color: #1976d2; }
        .status-preparing { background: #fff3cd; color: #856404; }
        .status-ready { background: #d4edda; color: #155724; }
        .status-completed { background: #d1ecf1; color: #0c5460; }
        
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin: 0 2px;
        }
        
        .view-btn { background: #3498db; color: white; }
        .complete-btn { background: #2ecc71; color: white; }
        .delete-btn { background: #e74c3c; color: white; }
        
        .export-section {
            text-align: center;
            margin-top: 30px;
        }
        
        .export-btn {
            background: #2e8b57;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .order-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close-modal {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        /* Delete Confirmation Modal */
        .delete-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }
        
        .delete-modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .delete-modal h3 {
            color: #e74c3c;
            margin-bottom: 15px;
        }
        
        .delete-modal p {
            margin-bottom: 20px;
            color: #666;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .cancel-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .confirm-delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 1002;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        .toast-success {
            background: #2ecc71;
        }
        
        .toast-error {
            background: #e74c3c;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @media (max-width: 768px) {
            .admin-header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            th, td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="admin-header">
        <div class="logo">SERADOS CAFE - ADMIN DASHBOARD</div>
        <div class="admin-info">
            <span>Welcome, Admin</span>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>
    
    <!-- Dashboard Content -->
    <div class="dashboard-container">
        <!-- Stats Cards -->
        <div class="stats-cards">
            <div class="stat-card">
                <h3>Total Orders</h3>
                <div class="number" id="totalOrders">0</div>
                <p>All time orders</p>
            </div>
            <div class="stat-card">
                <h3>Today's Orders</h3>
                <div class="number" id="todayOrders">0</div>
                <p>Orders placed today</p>
            </div>
            <div class="stat-card">
                <h3>Total Revenue</h3>
                <div class="number" id="totalRevenue">रु 0</div>
                <p>All time revenue</p>
            </div>
            <div class="stat-card">
                <h3>Pending Orders</h3>
                <div class="number" id="pendingOrders">0</div>
                <p>Awaiting preparation</p>
            </div>
        </div>
        
        <!-- Filter Controls -->
        <div class="controls">
            <button class="filter-btn active" onclick="filterOrders('all')">All Orders</button>
            <button class="filter-btn" onclick="filterOrders('received')">Received</button>
            <button class="filter-btn" onclick="filterOrders('preparing')">Preparing</button>
            <button class="filter-btn" onclick="filterOrders('ready')">Ready</button>
            <button class="filter-btn" onclick="filterOrders('completed')">Completed</button>
            <button class="filter-btn" onclick="filterOrders('today')">Today</button>
        </div>
        
        <!-- Orders Table -->
        <div class="orders-table">
            <div id="ordersTable">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading orders...
                </div>
            </div>
        </div>
        
        <!-- Export Button -->
        <div class="export-section">
            <button class="export-btn" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> Export to Excel
            </button>
        </div>
    </div>
    
    <!-- Order Details Modal -->
    <div class="order-details-modal" id="orderModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div id="orderDetails"></div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="delete-modal" id="deleteModal">
        <div class="delete-modal-content">
            <h3><i class="fas fa-exclamation-triangle"></i> Delete Order</h3>
            <p id="deleteMessage">Are you sure you want to delete this order? This action cannot be undone.</p>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeDeleteModal()">Cancel</button>
                <button class="confirm-delete-btn" onclick="confirmDelete()">Delete Order</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notifications -->
    <div class="toast" id="successToast">Operation completed successfully!</div>
    <div class="toast" id="errorToast">An error occurred. Please try again.</div>

    <script>
        // =============================================
        // AUTHENTICATION CHECK (MUST BE FIRST)
        // =============================================
        
        // Check if user is logged in using sessionStorage
        if (sessionStorage.getItem('seradosAdminLoggedIn') !== 'true') {
            // Redirect to login page if not logged in
            window.location.href = '/admin';
        }
        
        // Logout function
        function logout() {
            sessionStorage.removeItem('seradosAdminLoggedIn');
            sessionStorage.removeItem('seradosAdminUser');
            window.location.href = '/admin';
        }
        
        // =============================================
        // DASHBOARD FUNCTIONALITY
        // =============================================
        
        let allOrders = [];
        let currentFilter = 'all';
        let orderToDelete = null;
        
        // Load orders on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadOrders();
            await loadStatistics();
        });
        
        // Load all orders
        async function loadOrders() {
            try {
                const response = await fetch('/api/orders');
                allOrders = await response.json();
                displayOrders(allOrders);
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('ordersTable').innerHTML = 
                    '<div class="loading">Error loading orders. Please refresh.</div>';
            }
        }
        
        // Display orders in table
        function displayOrders(orders) {
            if (orders.length === 0) {
                document.getElementById('ordersTable').innerHTML = 
                    '<div class="loading">No orders found.</div>';
                return;
            }
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Phone</th>
                            <th>City</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            orders.forEach(order => {
                const orderDate = new Date(order.order_date);
                const formattedDate = orderDate.toLocaleDateString();
                const formattedTime = orderDate.toLocaleTimeString();
                
                // Count total items
                const totalItems = order.items.reduce((sum, item) => sum + item.quantity, 0);
                
                tableHTML += `
                    <tr>
                        <td><strong>${order.order_id}</strong></td>
                        <td>${order.customer_name}</td>
                        <td>${order.phone}</td>
                        <td>${order.city}</td>
                        <td>${totalItems} items</td>
                        <td>रु ${parseFloat(order.total_amount).toFixed(2)}</td>
                        <td>
                            <span class="status-badge status-${order.status}">
                                ${order.status.toUpperCase()}
                            </span>
                        </td>
                        <td>${formattedDate}<br>${formattedTime}</td>
                        <td>
                            <button class="action-btn view-btn" onclick="viewOrderDetails('${order.order_id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            ${order.status !== 'completed' ? `
                                <button class="action-btn complete-btn" onclick="updateStatus('${order.order_id}', 'completed')">
                                    <i class="fas fa-check"></i> Complete
                                </button>
                            ` : ''}
                            <button class="action-btn delete-btn" onclick="showDeleteModal('${order.order_id}', '${order.customer_name}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            document.getElementById('ordersTable').innerHTML = tableHTML;
        }
        
        // Filter orders
        function filterOrders(filterType) {
            currentFilter = filterType;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            let filteredOrders = allOrders;
            
            const today = new Date().toDateString();
            
            switch(filterType) {
                case 'received':
                    filteredOrders = allOrders.filter(order => order.status === 'received');
                    break;
                case 'preparing':
                    filteredOrders = allOrders.filter(order => order.status === 'preparing');
                    break;
                case 'ready':
                    filteredOrders = allOrders.filter(order => order.status === 'ready');
                    break;
                case 'completed':
                    filteredOrders = allOrders.filter(order => order.status === 'completed');
                    break;
                case 'today':
                    filteredOrders = allOrders.filter(order => 
                        new Date(order.order_date).toDateString() === today
                    );
                    break;
                // 'all' shows all orders
            }
            
            displayOrders(filteredOrders);
        }
        
        // View order details
        async function viewOrderDetails(orderId) {
            try {
                const response = await fetch(`/api/orders/${orderId}`);
                const order = await response.json();
                
                let itemsHTML = '';
                order.items.forEach(item => {
                    itemsHTML += `
                        <tr>
                            <td>${item.name}</td>
                            <td>${item.quantity}</td>
                            <td>रु ${item.price.toFixed(2)}</td>
                            <td>रु ${(item.price * item.quantity).toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                const detailsHTML = `
                    <h2>Order Details: ${order.order_id}</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div>
                            <h3>Customer Information</h3>
                            <p><strong>Name:</strong> ${order.customer_name}</p>
                            <p><strong>Phone:</strong> ${order.phone}</p>
                            <p><strong>City:</strong> ${order.city}</p>
                            <p><strong>Address:</strong> ${order.address}</p>
                            <p><strong>Pickup Time:</strong> ${order.pickup_time}</p>
                        </div>
                        <div>
                            <h3>Order Information</h3>
                            <p><strong>Order ID:</strong> ${order.order_id}</p>
                            <p><strong>Status:</strong> 
                                <select id="statusSelect" onchange="updateOrderStatus('${order.order_id}', this.value)" style="padding: 5px; margin-left: 10px;">
                                    <option value="received" ${order.status === 'received' ? 'selected' : ''}>Received</option>
                                    <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                                    <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Ready</option>
                                    <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Completed</option>
                                </select>
                            </p>
                            <p><strong>Order Date:</strong> ${new Date(order.order_date).toLocaleString()}</p>
                            <p><strong>Total Amount:</strong> रु ${order.total_amount}</p>
                        </div>
                    </div>
                    
                    <h3>Order Items</h3>
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 10px; text-align: left;">Item Name</th>
                                <th style="padding: 10px; text-align: left;">Quantity</th>
                                <th style="padding: 10px; text-align: left;">Price</th>
                                <th style="padding: 10px; text-align: left;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                            <tr style="border-top: 2px solid #333; font-weight: bold;">
                                <td colspan="3" style="padding: 10px; text-align: right;">Grand Total:</td>
                                <td style="padding: 10px;">रु ${order.total_amount}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="printOrder('${order.order_id}')" style="background: #2e8b57; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-print"></i> Print Order
                        </button>
                        <button onclick="showDeleteModal('${order.order_id}', '${order.customer_name}')" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-trash"></i> Delete Order
                        </button>
                    </div>
                `;
                
                document.getElementById('orderDetails').innerHTML = detailsHTML;
                document.getElementById('orderModal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading order details:', error);
                showToast('Error loading order details', 'error');
            }
        }
        
        // Update order status
        async function updateOrderStatus(orderId, status) {
            try {
                const response = await fetch(`/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast('Order status updated successfully!', 'success');
                    await loadOrders(); // Reload orders
                    await loadStatistics(); // Reload stats
                    
                    // If modal is open, update it
                    if (document.getElementById('orderModal').style.display === 'flex') {
                        viewOrderDetails(orderId);
                    }
                } else {
                    showToast('Failed to update order status', 'error');
                }
            } catch (error) {
                console.error('Error updating order:', error);
                showToast('Error updating order status', 'error');
            }
        }
        
        // Show delete confirmation modal
        function showDeleteModal(orderId, customerName) {
            orderToDelete = orderId;
            document.getElementById('deleteMessage').innerHTML = `
                Are you sure you want to delete order <strong>${orderId}</strong> 
                for customer <strong>${customerName}</strong>? 
                <br><br>
                <small>This action cannot be undone.</small>
            `;
            document.getElementById('deleteModal').style.display = 'flex';
        }
        
        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            orderToDelete = null;
        }
        
        // Confirm and delete order
        async function confirmDelete() {
            if (!orderToDelete) return;
            
            try {
                const response = await fetch(`/api/orders/${orderToDelete}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Order deleted successfully!', 'success');
                    closeDeleteModal();
                    closeModal(); // Also close order details modal if open
                    await loadOrders();
                    await loadStatistics();
                } else {
                    showToast('Failed to delete order: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error deleting order:', error);
                showToast('Error deleting order. Please try again.', 'error');
            }
        }
        
        // Load statistics
        async function loadStatistics() {
            try {
                const response = await fetch('/api/orders/stats');
                const stats = await response.json();
                
                // Calculate totals
                const totalOrders = allOrders.length;
                const today = new Date().toDateString();
                const todayOrders = allOrders.filter(order => 
                    new Date(order.order_date).toDateString() === today
                ).length;
                
                const totalRevenue = allOrders.reduce((sum, order) => sum + parseFloat(order.total_amount), 0);
                const pendingOrders = allOrders.filter(order => 
                    order.status === 'received' || order.status === 'preparing'
                ).length;
                
                // Update stats cards
                document.getElementById('totalOrders').textContent = totalOrders;
                document.getElementById('todayOrders').textContent = todayOrders;
                document.getElementById('totalRevenue').textContent = `रु ${totalRevenue.toFixed(2)}`;
                document.getElementById('pendingOrders').textContent = pendingOrders;
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }
        
        // Export to Excel
        function exportToExcel() {
            // Create CSV content
            let csv = 'Order ID,Customer Name,Phone,City,Address,Items,Total Amount,Status,Order Date\n';
            
            allOrders.forEach(order => {
                const itemsText = order.items.map(item => 
                    `${item.name} (x${item.quantity})`
                ).join('; ');
                
                csv += `"${order.order_id}","${order.customer_name}","${order.phone}","${order.city}","${order.address}","${itemsText}",${order.total_amount},"${order.status}","${order.order_date}"\n`;
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `serados_orders_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        // Print order
        function printOrder(orderId) {
            const printContent = document.getElementById('orderDetails').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = `
                <div style="padding: 20px; font-family: Arial, sans-serif;">
                    ${printContent}
                </div>
                <script>
                    window.onload = function() {
                        window.print();
                        setTimeout(function() {
                            document.body.innerHTML = originalContent;
                            location.reload();
                        }, 1000);
                    }
                <\/script>
            `;
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('orderModal').style.display = 'none';
        }
        
        // Update status from table
        async function updateStatus(orderId, status) {
            await updateOrderStatus(orderId, status);
        }
        
        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = type === 'success' ? 
                document.getElementById('successToast') : 
                document.getElementById('errorToast');
            
            toast.textContent = message;
            toast.className = `toast toast-${type}`;
            toast.style.display = 'block';
            
            // Hide after 3 seconds
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        // Auto-refresh orders every 30 seconds
        setInterval(async () => {
            await loadOrders();
            await loadStatistics();
        }, 30000);
    </script>
</body>
</html>
